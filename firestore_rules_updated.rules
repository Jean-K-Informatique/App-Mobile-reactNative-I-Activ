rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Fonction pour v√©rifier si l'utilisateur est authentifi√©
    function isAuthenticated() {
      return request.auth != null;
    }

    // Fonction pour v√©rifier si l'utilisateur est admin (m√©thode hybride)
    function isAdmin() {
      return isAdminOriginal() || isAdminNew();
    }
    
    // Fonction pour v√©rifier si l'utilisateur est admin avec l'ancienne m√©thode
    function isAdminOriginal() {
      return isAuthenticated() && (
        request.auth.uid == 'ZTDTVL6S1iRI9O05yfq5qmp3f143' || // Admin principal
        request.auth.uid == 'UFiHGOAkCgSaJE3WI0XyosLCKlB3' || // Admin 2
        request.auth.uid == '76FgBGcSiPeuWj00pS46A88lmoU2' || // Admin 3
        request.auth.uid == 'QSiSlibQ5nZeHbbeiOvL2n8WUF12'    // Admin 4
      );
    }
    
    // Fonction pour v√©rifier si l'utilisateur est admin avec la nouvelle m√©thode
    function isAdminNew() {
      return isAuthenticated() && exists(/databases/$(database)/documents/admin_roles/$(request.auth.uid));
    }
    
    // Fonction pour v√©rifier si l'utilisateur est admin d'une entreprise
    function isCompanyAdmin(companyId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/company_admins/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/company_admins/$(request.auth.uid)).data.companyId == companyId;
    }
    
    // Fonction pour v√©rifier si l'utilisateur est admin d'une entreprise (sans pr√©ciser l'entreprise)
    function isAnyCompanyAdmin() {
      return isAuthenticated() && exists(/databases/$(database)/documents/company_admins/$(request.auth.uid));
    }
    
    // R√©cup√©rer l'ID de l'entreprise dont l'utilisateur est admin
    function getAdminCompanyId() {
      return get(/databases/$(database)/documents/company_admins/$(request.auth.uid)).data.companyId;
    }

    // Collection admin_roles - G√©r√©e uniquement par les super admins
    match /admin_roles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Collection company_admins - G√©r√©e uniquement par les super admins
    match /company_admins/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin() || isAnyCompanyAdmin());
      allow write: if isAdmin();
    }
    
    // Collection companies - G√©r√©e par les super admins, accessible en lecture par les admins d'entreprise
    match /companies/{companyId} {
      allow read: if isAuthenticated() && (isAdmin() || isCompanyAdmin(companyId));
      allow write: if isAdmin();
    }

    // Collection tags (inclut les entreprises)
    match /tags/{tagId} {
      allow read: if isAuthenticated(); // Restreindre l'acc√®s aux utilisateurs authentifi√©s
      allow write: if isAdmin();
    }

    // Collection users - Acc√®s limit√© par entreprise pour les admins d'entreprise
    match /users/{userId} {
      // V√©rifier si l'utilisateur consulte son propre profil
      function isSelf() {
        return request.auth.uid == userId;
      }
      
      // V√©rifier si l'utilisateur est admin de l'entreprise √† laquelle appartient l'utilisateur consult√©
      function isUserCompanyAdmin() {
        return isAnyCompanyAdmin() && 
               resource.data.companyId != null && 
               resource.data.companyId == getAdminCompanyId();
      }
      
      // Les utilisateurs peuvent voir leur propre profil, les super-admins peuvent voir tous les profils
      // Les admins d'entreprise peuvent voir uniquement les utilisateurs de leur entreprise
      allow read: if isAuthenticated() && (isSelf() || isAdmin() || isUserCompanyAdmin());
      
      // Les utilisateurs peuvent cr√©er leur propre document utilisateur
      allow create: if isAuthenticated() && isSelf();
      
      // Les super-admins peuvent modifier/supprimer tous les profils
      allow update, delete: if isAdmin();
      
      // Les utilisateurs peuvent mettre √† jour certains champs de leur propre profil
      allow update: if isAuthenticated() && isSelf() && 
        (request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['firstName', 'lastName', 'photoURL', 'lastLogin', 'updatedAt', 'isGoogleAccount', 'companyId', 'email', 'customizationData'])) &&
        // ‚úÖ S√âCURIT√â RENFORC√âE : Interdire explicitement la modification de manualSubscription par l'utilisateur
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['manualSubscription']);
      
      // ‚úÖ NOUVEAU : Les super-admins peuvent g√©rer les acc√®s manuels (et SEULEMENT eux)
      allow update: if isAdmin() && 
        (request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['manualSubscription', 'updatedAt']) ||
         request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['manualSubscription'])) &&
        // ‚úÖ S√âCURIT√â : V√©rifier que l'utilisateur est bien un super-admin
        request.auth.uid in ['ZTDTVL6S1iRI9O05yfq5qmp3f143', 'UFiHGOAkCgSaJE3WI0XyosLCKlB3', '76FgBGcSiPeuWj00pS46A88lmoU2', 'QSiSlibQ5nZeHbbeiOvL2n8WUF12'];
      
      // Les admins d'entreprise peuvent mettre √† jour certains champs des utilisateurs de leur entreprise
      allow update: if isUserCompanyAdmin() && 
        (request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['lastLogin', 'updatedAt'])) &&
        // ‚úÖ S√âCURIT√â : Les admins d'entreprise ne peuvent PAS modifier manualSubscription
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['manualSubscription']);
      
      // Les admins d'entreprise peuvent supprimer les utilisateurs de leur entreprise
      allow delete: if isUserCompanyAdmin();
    }

    // Collection chats - Acc√®s limit√© aux super-admins pour l'√©criture et aux utilisateurs pour la lecture
    match /chats/{chatId} {
      // V√©rifier si l'utilisateur est admin de l'entreprise associ√©e au chat
      function isCompanyAdminForChat() {
        return isAnyCompanyAdmin() && (
          // Si le chat a un companyId sp√©cifique
          (resource.data.companyId != null && resource.data.companyId == getAdminCompanyId()) ||
          // Si le chat a un tableau companyIds
          (resource.data.companyIds != null && resource.data.companyIds.hasAny([getAdminCompanyId()])) ||
          // Si le chat n'a pas de restriction d'entreprise
          (resource.data.companyId == null && (resource.data.companyIds == null || resource.data.companyIds.size() == 0))
        );
      }
      
      // Permettre la lecture aux utilisateurs authentifi√©s qui ont acc√®s au chat
      // ou aux administrateurs
      // ‚úÖ S√âCURIT√â RENFORC√âE : Lecture stricte des chats
      allow read: if isAuthenticated() && (
        isAdmin() || 
        isCompanyAdminForChat() || 
        (resource.data.allowedUsers != null && resource.data.allowedUsers.hasAny([request.auth.uid]))
      );
      
      // Cr√©ation et suppression r√©serv√©es aux super-admins
      allow create, delete: if isAdmin();
      
      // Permettre aux admins d'entreprise de mettre √† jour uniquement le champ allowedUsers des chats
      allow update: if isAdmin() || (
        isAuthenticated() && 
        isCompanyAdminForChat() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['allowedUsers', 'updatedAt', 'updatedBy'])
      );
      
      // ‚úÖ NOUVELLE R√àGLE : Permettre au syst√®me d'abonnement de modifier allowedUsers
      allow update: if isAuthenticated() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['allowedUsers', 'updatedAt', 'updatedBy']) &&
        (
          // ‚úÖ AM√âLIORATION : Supporter tous les types d'updates automatiques d'abonnement
          request.resource.data.updatedBy in [
            'subscription_system', 
            'subscription_cleanup', 
            'subscription_auto_basic',
            'subscription_auto_essential', 
            'subscription_auto_performance',
            'subscription_auto_unlimited',
            'subscription_auto_premium'
          ] ||
          // ‚úÖ NOUVEAU : V√©rifier que updatedBy commence par 'subscription_'
          (request.resource.data.updatedBy is string && 
           request.resource.data.updatedBy.size() > 12 &&
           request.resource.data.updatedBy[0:13] == 'subscription_')
        ) &&
        // ‚úÖ S√âCURIT√â : L'utilisateur ne peut se modifier que lui-m√™me dans allowedUsers
        (
          // Cas 1: Ajout de l'utilisateur √† allowedUsers
          (resource.data.allowedUsers == null || !resource.data.allowedUsers.hasAny([request.auth.uid])) &&
          request.resource.data.allowedUsers.hasAny([request.auth.uid]) &&
          request.resource.data.allowedUsers.size() == (resource.data.allowedUsers != null ? resource.data.allowedUsers.size() + 1 : 1) ||
          // Cas 2: Suppression de l'utilisateur d'allowedUsers  
          resource.data.allowedUsers != null && 
          resource.data.allowedUsers.hasAny([request.auth.uid]) &&
          !request.resource.data.allowedUsers.hasAny([request.auth.uid]) &&
          request.resource.data.allowedUsers.size() == resource.data.allowedUsers.size() - 1
        );
    }

    // Collection documents - Accessible en lecture aux utilisateurs authentifi√©s, √©criture par les super-admins
    match /documents/{documentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Collection document_chunks - Accessible en lecture aux utilisateurs authentifi√©s, √©criture par les super-admins
    match /document_chunks/{chunkId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Collection messages - Accessible en lecture aux utilisateurs authentifi√©s, √©criture par tous les utilisateurs
    match /chats/{chatId}/messages/{messageId} {
      function hasChatAccess() {
        return request.auth != null && (get(/databases/$(database)/documents/chats/$(chatId)).data.allowedUsers.hasAny([request.auth.uid]) || isAdmin());
      }
      allow read: if hasChatAccess();
      allow create: if hasChatAccess() && (request.resource.data.uid == request.auth.uid || request.resource.data.uid == 'assistant'); // Allow 'assistant' for AI if user has access
      allow update, delete: if isAdmin();
    }
    
    // Collection dalle_quotas - G√©r√©e uniquement par les super-admins
    match /dalle_quotas/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAdmin();
    }
    
    // Collection usage - Statistiques d'utilisation, accessible uniquement aux super-admins, et autorisation d'√©criture pour les utilisateurs authentifi√©s
    match /usage/{usageId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // Collection user_totals - Totaux par utilisateur, accessible aux utilisateurs pour leur propre total
    match /user_totals/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create, update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Collection sessions - Gestion des sessions utilisateur
    match /sessions/{sessionId} {
      allow read: if isAuthenticated() && (request.auth.uid == sessionId || isAdmin());
      allow create, update: if isAuthenticated() && (request.auth.uid == sessionId || isAdmin());
    }
    
    // Collection quick_questions - Questions rapides g√©r√©es par les super-admins
    match /quick_questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Collection assistants_recherche - Assistants de recherche configurables
    match /assistants_recherche/{assistantId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ========== NOUVELLES R√àGLES POUR LE SYST√àME D'ABONNEMENTS ==========
    
    // Collection chat_plan_associations - Gestion des associations chats ‚Üî plans d'abonnement
    match /chat_plan_associations/{associationId} {
      // ‚úÖ CORRECTION : Permettre la lecture aux utilisateurs authentifi√©s pour les services abonnement
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Mise √† jour des r√®gles users pour inclure les donn√©es d'abonnement
    // (Les r√®gles users existantes sont d√©j√† d√©finies plus haut, mais on ajoute un commentaire)
    // Les champs subscription, usage, limits dans la collection users sont d√©j√† couverts
    // par les r√®gles existantes qui permettent aux admins et aux utilisateurs de modifier leurs propres donn√©es
    
    // Collection web_search_usage - Quotas de recherche Internet par utilisateur/jour
    match /web_search_usage/{usageId} {
      // Extraire l'ID utilisateur du document (format: userId_YYYY-MM-DD)
      function getUserIdFromUsageId() {
        return usageId.split('_')[0];
      }
      
      // V√©rifier si l'utilisateur consulte son propre usage
      function isOwnUsage() {
        return request.auth.uid == getUserIdFromUsageId();
      }
      
      // Lecture: utilisateur pour son propre usage ou admins pour tous
      allow read: if isAuthenticated() && (isOwnUsage() || isAdmin());
      
      // Cr√©ation/Mise √† jour: utilisateur pour son propre usage ou admins pour tous
      allow create, update: if isAuthenticated() && (
        (isOwnUsage() && request.resource.data.userId == request.auth.uid) || 
        isAdmin()
      );
      
      // Suppression: uniquement les admins
      allow delete: if isAdmin();
    }

    // Collection user_subscriptions - Gestion des abonnements utilisateur
    match /user_subscriptions/{userId} {
      // V√©rifier si l'utilisateur consulte son propre abonnement
      function isOwnSubscription() {
        return request.auth.uid == userId;
      }
      
      // Lecture: utilisateur pour son propre abonnement ou admins pour tous
      allow read: if isAuthenticated() && (isOwnSubscription() || isAdmin());
      
      // Cr√©ation/Mise √† jour: uniquement les admins (pour s√©curit√© des abonnements)
      allow create, update: if isAdmin();
      
      // Suppression: uniquement les admins
      allow delete: if isAdmin();
    }

    // Collection subscriptions - Abonnements Stripe synchronis√©s via webhook
    match /subscriptions/{subscriptionId} {
      // ‚úÖ S√âCURIT√â RENFORC√âE : Fonction pour v√©rifier l'acc√®s avec priorit√© userId
      function isOwnSubscription() {
        return isAuthenticated() && (
          // ‚úÖ PRIORIT√â 1: Si userId est renseign√©, v√©rification stricte
          (resource.data.userId != null && resource.data.userId == request.auth.uid) ||
          // ‚úÖ PRIORIT√â 2: Si userId est null, fallback par email (cas orphelins temporaires)
          // Utiliser l'email depuis le token Firebase (plus fiable)
          (resource.data.userId == null && resource.data.customer_email == request.auth.token.email) ||
          // ‚úÖ PRIORIT√â 3: Fallback avec email depuis les identit√©s Firebase
          (resource.data.userId == null && 
           request.auth.token.firebase != null && 
           request.auth.token.firebase.identities != null &&
           request.auth.token.firebase.identities.email != null &&
           resource.data.customer_email in request.auth.token.firebase.identities.email)
        );
      }
      
      // Lecture: utilisateur pour son propre abonnement OU admins pour tous
      allow read: if isAuthenticated() && (isOwnSubscription() || isAdmin());
      
      // Cr√©ation/Mise √† jour: admins + service webhook (pour synchronisation Stripe)
      allow create, update: if isAdmin();
      
      // Suppression: uniquement les admins
      allow delete: if isAdmin();
    }

    // ‚úÖ NOUVELLES COLLECTIONS SYST√àME ABONNEMENTS WEBHOOK
    
    // Collection subscription_activity - Activit√© temps r√©el des abonnements
    match /subscription_activity/{activityId} {
      // Fonction pour v√©rifier si l'utilisateur consulte sa propre activit√©
      function isOwnActivity() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.customer_email == request.auth.token.email) ||
          (request.auth.token.firebase != null && 
           request.auth.token.firebase.identities != null &&
           request.auth.token.firebase.identities.email != null &&
           resource.data.customer_email in request.auth.token.firebase.identities.email)
        );
      }
      
      // Lecture: utilisateur pour sa propre activit√© OU admins pour tous
      allow read: if isAuthenticated() && (isOwnActivity() || isAdmin());
      
      // Cr√©ation/Mise √† jour: admins + service webhook
      allow create, update: if isAdmin();
      
      // Suppression: uniquement les admins
      allow delete: if isAdmin();
    }
    
    // Collection payments - Historique des paiements Stripe
    match /payments/{paymentId} {
      // Fonction pour v√©rifier si l'utilisateur consulte ses propres paiements
      function isOwnPayment() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.customer_email == request.auth.token.email) ||
          (request.auth.token.firebase != null && 
           request.auth.token.firebase.identities != null &&
           request.auth.token.firebase.identities.email != null &&
           resource.data.customer_email in request.auth.token.firebase.identities.email)
        );
      }
      
      // Lecture: utilisateur pour ses propres paiements OU admins pour tous
      allow read: if isAuthenticated() && (isOwnPayment() || isAdmin());
      
      // Cr√©ation/Mise √† jour: admins + service webhook
      allow create, update: if isAdmin();
      
      // Suppression: uniquement les admins
      allow delete: if isAdmin();
    }
    
    // Collection payment_failures - √âchecs de paiement
    match /payment_failures/{failureId} {
      // Fonction pour v√©rifier si l'utilisateur consulte ses propres √©checs
      function isOwnFailure() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.customer_email == request.auth.token.email) ||
          (request.auth.token.firebase != null && 
           request.auth.token.firebase.identities != null &&
           request.auth.token.firebase.identities.email != null &&
           resource.data.customer_email in request.auth.token.firebase.identities.email)
        );
      }
      
      // Lecture: utilisateur pour ses propres √©checs OU admins pour tous
      allow read: if isAuthenticated() && (isOwnFailure() || isAdmin());
      
      // Cr√©ation/Mise √† jour: admins + service webhook
      allow create, update: if isAdmin();
      
      // Suppression: uniquement les admins
      allow delete: if isAdmin();
    }
    
    // Collection user_access_cache - Cache des droits utilisateur
    match /user_access_cache/{userId} {
      // V√©rifier si l'utilisateur consulte son propre cache
      function isOwnCache() {
        return request.auth.uid == userId;
      }
      
      // Lecture: utilisateur pour son propre cache OU admins pour tous
      allow read: if isAuthenticated() && (isOwnCache() || isAdmin());
      
      // Cr√©ation/Mise √† jour: admins + service webhook
      allow create, update: if isAdmin();
      
      // Suppression: uniquement les admins
      allow delete: if isAdmin();
    }
    
    // Collection orphan_subscriptions - Abonnements sans utilisateur Firebase
    match /orphan_subscriptions/{orphanId} {
      // Lecture: uniquement les admins (donn√©es sensibles)
      allow read: if isAdmin();
      
      // Cr√©ation/Mise √† jour: admins + service webhook
      allow create, update: if isAdmin();
      
      // Suppression: uniquement les admins
      allow delete: if isAdmin();
    }

    // ========== üÜï NOUVELLES R√àGLES POUR L'HISTORIQUE DES CONVERSATIONS ==========
    
    // Collection conversations - Gestion de l'historique des conversations utilisateur
    match /conversations/{conversationId} {
      // V√©rifier si l'utilisateur est propri√©taire de la conversation
      function isOwnConversation() {
        return isAuthenticated() && request.auth.uid == resource.data.userId;
      }
      
      // V√©rifier si l'utilisateur est propri√©taire lors de la cr√©ation
      function isCreatingOwnConversation() {
        return isAuthenticated() && request.auth.uid == request.resource.data.userId;
      }
      
      // Lecture: utilisateur pour ses propres conversations OU admins pour toutes
      allow read: if isAuthenticated() && (isOwnConversation() || isAdmin());
      
      // Cr√©ation: utilisateur pour ses propres conversations OU admins
      allow create: if isAuthenticated() && (isCreatingOwnConversation() || isAdmin());
      
      // Mise √† jour: utilisateur pour ses propres conversations OU admins
      allow update: if isAuthenticated() && (isOwnConversation() || isAdmin());
      
      // Suppression: utilisateur pour ses propres conversations OU admins
      allow delete: if isAuthenticated() && (isOwnConversation() || isAdmin());
    }
    
    // Collection messages des conversations - Sous-collection de conversations
    match /conversations/{conversationId}/messages/{messageId} {
      // V√©rifier si l'utilisateur poss√®de la conversation parente
      function ownsParentConversation() {
        return isAuthenticated() && 
               request.auth.uid == get(/databases/$(database)/documents/conversations/$(conversationId)).data.userId;
      }
      
      // Lecture: utilisateur propri√©taire de la conversation OU admins
      allow read: if isAuthenticated() && (ownsParentConversation() || isAdmin());
      
      // Cr√©ation: utilisateur propri√©taire de la conversation OU admins
      allow create: if isAuthenticated() && (ownsParentConversation() || isAdmin());
      
      // Mise √† jour: utilisateur propri√©taire de la conversation OU admins
      allow update: if isAuthenticated() && (ownsParentConversation() || isAdmin());
      
      // Suppression: utilisateur propri√©taire de la conversation OU admins
      allow delete: if isAuthenticated() && (ownsParentConversation() || isAdmin());
    }
  }
} 